<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>리액트 쿼리로 낙관적 업데이트 수행하기 | Wh@t !s Development?</title>
    <meta name="generator" content="VuePress 1.9.10">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-C7NTCRQ25E"></script>
    <script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-C7NTCRQ25E');</script>
    <meta name="description" content="배워가고 있는 현업..? 대학생 개발자">
    
    <link rel="preload" href="/assets/css/0.styles.d0292b10.css" as="style"><link rel="preload" href="/assets/js/app.ddc79771.js" as="script"><link rel="preload" href="/assets/js/1.00a05d18.js" as="script"><link rel="preload" href="/assets/js/26.fa87e3a1.js" as="script"><link rel="prefetch" href="/assets/js/10.dfcccddd.js"><link rel="prefetch" href="/assets/js/11.6b83b439.js"><link rel="prefetch" href="/assets/js/12.d56c10e2.js"><link rel="prefetch" href="/assets/js/13.9a7e722a.js"><link rel="prefetch" href="/assets/js/14.c77e849e.js"><link rel="prefetch" href="/assets/js/15.6edac085.js"><link rel="prefetch" href="/assets/js/16.4aa95d0a.js"><link rel="prefetch" href="/assets/js/17.b6aa454d.js"><link rel="prefetch" href="/assets/js/18.c63b30d1.js"><link rel="prefetch" href="/assets/js/19.ac53068d.js"><link rel="prefetch" href="/assets/js/2.f29d7a36.js"><link rel="prefetch" href="/assets/js/20.ca4439f5.js"><link rel="prefetch" href="/assets/js/21.e494406c.js"><link rel="prefetch" href="/assets/js/22.2c5c23b6.js"><link rel="prefetch" href="/assets/js/23.46ee9f2a.js"><link rel="prefetch" href="/assets/js/24.dae06283.js"><link rel="prefetch" href="/assets/js/25.57ee23f4.js"><link rel="prefetch" href="/assets/js/27.8bad4a4a.js"><link rel="prefetch" href="/assets/js/28.c022dafb.js"><link rel="prefetch" href="/assets/js/29.832754dd.js"><link rel="prefetch" href="/assets/js/30.d6e6a2b7.js"><link rel="prefetch" href="/assets/js/31.e58352c6.js"><link rel="prefetch" href="/assets/js/32.3cf6010b.js"><link rel="prefetch" href="/assets/js/33.dbf0acb0.js"><link rel="prefetch" href="/assets/js/34.c86bebc8.js"><link rel="prefetch" href="/assets/js/35.ed0db922.js"><link rel="prefetch" href="/assets/js/36.fe356a5e.js"><link rel="prefetch" href="/assets/js/37.10850e5b.js"><link rel="prefetch" href="/assets/js/38.2dcc607c.js"><link rel="prefetch" href="/assets/js/39.7c0f35e0.js"><link rel="prefetch" href="/assets/js/4.1ba239d4.js"><link rel="prefetch" href="/assets/js/40.8b87d3bf.js"><link rel="prefetch" href="/assets/js/41.f30deeb0.js"><link rel="prefetch" href="/assets/js/42.57b77ea8.js"><link rel="prefetch" href="/assets/js/43.b3315ca4.js"><link rel="prefetch" href="/assets/js/44.b17508ca.js"><link rel="prefetch" href="/assets/js/45.5b5c19a7.js"><link rel="prefetch" href="/assets/js/46.9e8ce819.js"><link rel="prefetch" href="/assets/js/47.28b35706.js"><link rel="prefetch" href="/assets/js/48.c0d87fd4.js"><link rel="prefetch" href="/assets/js/49.a1b41e8c.js"><link rel="prefetch" href="/assets/js/5.4eb38bec.js"><link rel="prefetch" href="/assets/js/50.8bba066d.js"><link rel="prefetch" href="/assets/js/51.8cf81ea4.js"><link rel="prefetch" href="/assets/js/52.a18442c1.js"><link rel="prefetch" href="/assets/js/53.9c4363f6.js"><link rel="prefetch" href="/assets/js/54.aa373bcf.js"><link rel="prefetch" href="/assets/js/55.71982d82.js"><link rel="prefetch" href="/assets/js/56.5abff6bf.js"><link rel="prefetch" href="/assets/js/57.0b66cd56.js"><link rel="prefetch" href="/assets/js/58.100b73b8.js"><link rel="prefetch" href="/assets/js/59.d9855a7f.js"><link rel="prefetch" href="/assets/js/6.d4f3d3fa.js"><link rel="prefetch" href="/assets/js/60.9e38f4e1.js"><link rel="prefetch" href="/assets/js/61.af4308f2.js"><link rel="prefetch" href="/assets/js/62.ccf1ac4f.js"><link rel="prefetch" href="/assets/js/63.c993d191.js"><link rel="prefetch" href="/assets/js/64.4471c1d1.js"><link rel="prefetch" href="/assets/js/65.e293c8a4.js"><link rel="prefetch" href="/assets/js/66.a2258361.js"><link rel="prefetch" href="/assets/js/67.b465570a.js"><link rel="prefetch" href="/assets/js/68.f5faede9.js"><link rel="prefetch" href="/assets/js/69.c5c7f24b.js"><link rel="prefetch" href="/assets/js/7.48b87eb4.js"><link rel="prefetch" href="/assets/js/70.a96c8ea1.js"><link rel="prefetch" href="/assets/js/71.6699ca68.js"><link rel="prefetch" href="/assets/js/72.cd05fcfb.js"><link rel="prefetch" href="/assets/js/73.6570ccec.js"><link rel="prefetch" href="/assets/js/74.6d9157b7.js"><link rel="prefetch" href="/assets/js/75.8b8f1b93.js"><link rel="prefetch" href="/assets/js/76.a1c0b7d3.js"><link rel="prefetch" href="/assets/js/77.e2237a8d.js"><link rel="prefetch" href="/assets/js/78.36aa1e85.js"><link rel="prefetch" href="/assets/js/79.92afca59.js"><link rel="prefetch" href="/assets/js/8.307db6b1.js"><link rel="prefetch" href="/assets/js/80.46b201f7.js"><link rel="prefetch" href="/assets/js/81.9939db5b.js"><link rel="prefetch" href="/assets/js/82.431ad0b8.js"><link rel="prefetch" href="/assets/js/83.2f42c6fa.js"><link rel="prefetch" href="/assets/js/84.156f49d3.js"><link rel="prefetch" href="/assets/js/85.f34a6202.js"><link rel="prefetch" href="/assets/js/86.060681ff.js"><link rel="prefetch" href="/assets/js/87.ddb48362.js"><link rel="prefetch" href="/assets/js/9.f92da099.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d0292b10.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="layout"><div id="navbar"><nav role="navigation" aria-label="main navigation" class="navbar"><div class="navbar-brand"><a href="/" class="navbar-item" style="font-weight:bold;color:black;">
      Wh@t !s Development?
    </a><a role="button" aria-label="menu" tabindex="0" class="navbar-burger burger"><span aria-hidden="true"></span><span aria-hidden="true"></span><span aria-hidden="true"></span></a></div><div class="navbar-menu"><div class="navbar-start"></div><div class="navbar-end"><a href="/" class="navbar-item">
      Home
    </a><a href="/about" class="navbar-item">
      About
    </a> <a href="/posts/app" class="navbar-item">
      앱
    </a><a href="/posts/cs" class="navbar-item">
      CS
    </a><a href="/posts/web" class="navbar-item">
      Web
    </a><a href="/posts/etc" class="navbar-item">
      그 외
    </a> <div class="navbar-item"><div class="buttons"><button type="button" class="button is-info"><!----><!----><span class="icon is-small"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="svg-inline--fa fa-github fa-w-16"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></span></button> <button type="button" class="button is-info"><!----><!----><span class="icon is-small"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="instagram" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="svg-inline--fa fa-instagram fa-w-14"><path fill="currentColor" d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"></path></svg></span></button> <button type="button" class="button is-info"><!----><span><span class="icon is-small"><img src="/images/white_notion.svg" width="15" height="15"></span></span><!----></button></div></div></div></div></nav></div> <div class="content"><div class="page post"><div class="columns"><div class="column"><p class="title is-4">리액트 쿼리로 낙관적 업데이트 수행하기</p></div> <div class="column is-2"><p class="subtitle is-5 date">2023-08-05 19:30:00</p></div></div> <div class="content__default" style="paddig:0;"><img src="/assets/img/react-query-logo.d9405780.png"> <h3 id="문제-상황">문제 상황</h3> <blockquote><p>“댓글 수정/삭제/신고 후에 데이터를 모두 다시 불러오지 않고 갱신시켜야 해요”</p></blockquote> <p>React 프로젝트에서 이미 구현돼있는 댓글에 수정/삭제/신고를 수행해도 게시글의 내용을 다시 불러오지 않게 하고 싶다는 요구사항이 있었다. 사실 상용 서비스에서는 어떻게 보면 당연한 요구사항이다. 그냥 해당 댓글의 데이터만 바꾸면 리액트가 알아서 변경사항을 감지해서 리렌더 하겠지만 댓글에 Infinite loading까지 적용해야 하는 복잡한 상황에서 React-Query의 도입을 고민해 볼 수 밖에 없었다.</p> <h3 id="optimistic-update">Optimistic Update?</h3> <p>mutation을 수행하기 전에 mutation이 성공할 것으로 가정하고 결과로 예상되는 값으로 미리 업데이트해두는 것. 수행하고 나면 query가 캐시에 의존해 작동하는 stale 상태가 된다.</p> <h3 id="그냥-querydata를-set-해주자">그냥 queryData를 set 해주자</h3> <p>Optimistic Update를 수행하는 방법은 단순히 성공하고 나서 UI에 반영 될 것으로 예상되는 데이터를 쿼리 데이터로 set 해주면 된다.</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">const</span> commentQueryKey <span class="token operator">=</span> <span class="token string">&quot;comments&quot;</span>
<span class="token comment">// fetchComments는 댓글의 리스트를 반환한다.</span>
<span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token function">useQuery</span><span class="token punctuation">(</span>commentQueryKey<span class="token punctuation">,</span> commentApi<span class="token punctuation">.</span>editComment<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> commentMutation <span class="token operator">=</span> <span class="token function">useMutation</span><span class="token punctuation">(</span>commentApi<span class="token punctuation">.</span>editComment<span class="token punctuation">,</span> <span class="token punctuation">{</span>
	<span class="token function-variable function">onMutate</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>id<span class="token punctuation">,</span> content<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token comment">// 기존 데이터를 queryKey를 이용해 가져온 다음</span>
		<span class="token keyword">const</span> oldData <span class="token operator">=</span> queryClient<span class="token punctuation">.</span><span class="token function">getQueryData</span><span class="token punctuation">(</span>commentQueryKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 기존 데이터에서 id가 같은 것의 데이터를 변경한다.</span>
		<span class="token keyword">const</span> newData <span class="token operator">=</span> oldData<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">comment</span> <span class="token operator">=&gt;</span> comment<span class="token punctuation">.</span>id <span class="token operator">===</span> id <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token operator">...</span>comment<span class="token punctuation">,</span> content<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">:</span> comment<span class="token punctuation">)</span>
		<span class="token comment">// 새로운 데이터를 query data로 업데이트한다.</span>
		queryClient<span class="token punctuation">.</span><span class="token function">setQueryData</span><span class="token punctuation">(</span>commentQueryKey<span class="token punctuation">,</span> newData<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> queryClient <span class="token operator">=</span> <span class="token function">useQueryClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">onCommentEdited</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> content</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> commentMutation<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>id<span class="token punctuation">,</span> content<span class="token punctuation">}</span><span class="token punctuation">)</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="문제점">문제점</h3> <p>그런데, 이렇게 하게 되면 순간 업데이트 한 데이터로 변경되긴 하지만 이내 원래 데이터로 돌아오게 된다. 이 원인에 대해서는 아래 블로그에서 아주 상세하게 설명한다.</p> <p><a href="https://velog.io/@mskwon/react-query-cancel-queries" target="_blank" rel="noopener noreferrer">react-query optimistic update시 데이터 꼬임 방지<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>간단하게 설명하자면, remount로 인해 mutation 수행 도중 refetching이 일어나고, mutation 수행 도중 refetching 된 데이터는 이전의 데이터이므로 이전의 데이터로 덮어 씌워지게 되는 것이다.</p> <p>그런데 이해가 잘 가지 않았다. <code>mutation.mutate</code> 를 호출한다고 해서 왜 remount가 일어나는 것일까?</p> <p>사실 이유는 단순하다. 리액트 쿼리의 코드를 뒤져보다가 깨닳을 수 있었다.</p> <p>무언가 remount를 시키는 요소를 찾을 수 있지 않을까 해서 mutate의 콜스택을 따라가 보았다. mutate → Mutation.addObserver → notify → onSuccess/onSettled/onError 인 것인데, 생각해보면 mutation의 상태가 변하면 remount가 일어나고, mutation에 의존적이지 않은 query 훅은 remount를 인식하는 것이 당연했다. (..)</p> <p>어쨌든 결론은 refetch가 일어난다는 것이고, 이를 막아줘야 한다는 것이다.</p> <p><img src="/assets/img/lifecycle.56e9938c.gif" alt="Screen-Recording-2023-08-04-at-13.47.44.gif"></p> <h3 id="그냥-cancel-시켜주면-됩니다">그냥 cancel 시켜주면 됩니다.</h3> <p>사실 원인을 너무 장황하게 풀어썼지만, 그냥 캔슬 시켜주면 되는 문제다.</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">const</span> commentQueryKey <span class="token operator">=</span> <span class="token string">&quot;comments&quot;</span>
<span class="token comment">// fetchComments는 댓글의 리스트를 반환한다.</span>
<span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token function">useQuery</span><span class="token punctuation">(</span>commentQueryKey<span class="token punctuation">,</span> commentApi<span class="token punctuation">.</span>editComment<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> commentMutation <span class="token operator">=</span> <span class="token function">useMutation</span><span class="token punctuation">(</span>commentApi<span class="token punctuation">.</span>editComment<span class="token punctuation">,</span> <span class="token punctuation">{</span>
	<span class="token function-variable function">onMutate</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>id<span class="token punctuation">,</span> content<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token comment">// 우선 기존의 쿼리를 Cancel 시켜줍니다. </span>
		<span class="token operator">**</span>queryClient<span class="token punctuation">.</span><span class="token function">cancelQueries</span><span class="token punctuation">(</span>commentQueryKey<span class="token punctuation">)</span><span class="token operator">**</span>
		<span class="token comment">// 기존 데이터를 queryKey를 이용해 가져온 다음</span>
		<span class="token keyword">const</span> oldData <span class="token operator">=</span> queryClient<span class="token punctuation">.</span><span class="token function">getQueryData</span><span class="token punctuation">(</span>commentQueryKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 기존 데이터에서 id가 같은 것의 데이터를 변경한다.</span>
		<span class="token keyword">const</span> newData <span class="token operator">=</span> oldData<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">comment</span> <span class="token operator">=&gt;</span> comment<span class="token punctuation">.</span>id <span class="token operator">===</span> id <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token operator">...</span>comment<span class="token punctuation">,</span> content<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">:</span> comment<span class="token punctuation">)</span>
		<span class="token comment">// 새로운 데이터를 query data로 업데이트한다.</span>
		queryClient<span class="token punctuation">.</span><span class="token function">setQueryData</span><span class="token punctuation">(</span>commentQueryKey<span class="token punctuation">,</span> newData<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token punctuation">{</span>previousData<span class="token punctuation">,</span> newData<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> queryClient <span class="token operator">=</span> <span class="token function">useQueryClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">onCommentEdited</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> content</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> commentMutation<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>id<span class="token punctuation">,</span> content<span class="token punctuation">}</span><span class="token punctuation">)</span> 

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="사후-처리">사후 처리</h3> <ol><li>성공/실패 여부 관계 없이 서버에서 새로 갖고 오기</li></ol> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">const</span> commentMutation <span class="token operator">=</span> <span class="token function">useMutation</span><span class="token punctuation">(</span>commentApi<span class="token punctuation">.</span>editComment<span class="token punctuation">,</span> <span class="token punctuation">{</span>
	<span class="token function-variable function">onMutate</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>id<span class="token punctuation">,</span> content<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token operator">...</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token comment">// mutation이 성공하든 실패하든 비동기 작업이 끝나면</span>
	<span class="token function-variable function">onSettled</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token comment">// 쿼리의 캐시를 날리고 새로운 서버 데이터를 갖고 오게 한다.</span>
		queryClient<span class="token punctuation">.</span><span class="token function">invalidateQueries</span><span class="token punctuation">(</span>commentQueryKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol><li>에러 발생 시에만 롤백하기</li></ol> <p>성공 시에는 Optimistic Update 한 대로 두거나 필요한 로직을 수행하면서  에러가 발생하면 롤백을 시도한다.</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">const</span> commentMutation <span class="token operator">=</span> <span class="token function">useMutation</span><span class="token punctuation">(</span>commentApi<span class="token punctuation">.</span>editComment<span class="token punctuation">,</span> <span class="token punctuation">{</span>
	<span class="token function-variable function">onMutate</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>id<span class="token punctuation">,</span> content<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token operator">...</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token function-variable function">onSuccess</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;댓글을 수정했습니다.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token comment">// mutation이 성공하든 실패하든 비동기 작업이 끝나면</span>
	<span class="token function-variable function">onError</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> newComment<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token comment">// context에 담고 있는 previousData로 롤백!</span>
		queryClient<span class="token punctuation">.</span><span class="token function">setQueryData</span><span class="token punctuation">(</span>
      context<span class="token punctuation">.</span>previousData
    <span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="참고-문서">참고 문서</h3> <p><a href="https://velog.io/@kimhyo_0218/React-Query-%EB%A6%AC%EC%95%A1%ED%8A%B8-%EC%BF%BC%EB%A6%AC-useMutation-%EC%8B%A4%EC%9A%A9-%ED%8E%B8custom-hook-%EC%9C%BC%EB%A1%9C-%EC%82%AC%EC%9A%A9%ED%95%B4%EB%B3%B4%EC%9E%90" target="_blank" rel="noopener noreferrer">[React Query] 리액트 쿼리 useMutation 실용 편(custom hook 으로 사용해보자)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <div id="disqus_thread" class="comment"></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ddc79771.js" defer></script><script src="/assets/js/1.00a05d18.js" defer></script><script src="/assets/js/26.fa87e3a1.js" defer></script>
  </body>
</html>
