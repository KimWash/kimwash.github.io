<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MVVM - Mutation 처리를 예쁘게, 제대로 해보아요. | Wh@t !s Development?</title>
    <meta name="generator" content="VuePress 1.9.10">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-C7NTCRQ25E"></script>
    <script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-C7NTCRQ25E');</script>
    <meta name="description" content="배워가고 있는 현업..? 대학생 개발자">
    
    <link rel="preload" href="/assets/css/0.styles.d0292b10.css" as="style"><link rel="preload" href="/assets/js/app.ddc79771.js" as="script"><link rel="preload" href="/assets/js/1.00a05d18.js" as="script"><link rel="preload" href="/assets/js/40.8b87d3bf.js" as="script"><link rel="prefetch" href="/assets/js/10.dfcccddd.js"><link rel="prefetch" href="/assets/js/11.6b83b439.js"><link rel="prefetch" href="/assets/js/12.d56c10e2.js"><link rel="prefetch" href="/assets/js/13.9a7e722a.js"><link rel="prefetch" href="/assets/js/14.c77e849e.js"><link rel="prefetch" href="/assets/js/15.6edac085.js"><link rel="prefetch" href="/assets/js/16.4aa95d0a.js"><link rel="prefetch" href="/assets/js/17.b6aa454d.js"><link rel="prefetch" href="/assets/js/18.c63b30d1.js"><link rel="prefetch" href="/assets/js/19.ac53068d.js"><link rel="prefetch" href="/assets/js/2.f29d7a36.js"><link rel="prefetch" href="/assets/js/20.ca4439f5.js"><link rel="prefetch" href="/assets/js/21.e494406c.js"><link rel="prefetch" href="/assets/js/22.2c5c23b6.js"><link rel="prefetch" href="/assets/js/23.46ee9f2a.js"><link rel="prefetch" href="/assets/js/24.dae06283.js"><link rel="prefetch" href="/assets/js/25.57ee23f4.js"><link rel="prefetch" href="/assets/js/26.fa87e3a1.js"><link rel="prefetch" href="/assets/js/27.8bad4a4a.js"><link rel="prefetch" href="/assets/js/28.c022dafb.js"><link rel="prefetch" href="/assets/js/29.832754dd.js"><link rel="prefetch" href="/assets/js/30.d6e6a2b7.js"><link rel="prefetch" href="/assets/js/31.e58352c6.js"><link rel="prefetch" href="/assets/js/32.3cf6010b.js"><link rel="prefetch" href="/assets/js/33.dbf0acb0.js"><link rel="prefetch" href="/assets/js/34.c86bebc8.js"><link rel="prefetch" href="/assets/js/35.ed0db922.js"><link rel="prefetch" href="/assets/js/36.fe356a5e.js"><link rel="prefetch" href="/assets/js/37.10850e5b.js"><link rel="prefetch" href="/assets/js/38.2dcc607c.js"><link rel="prefetch" href="/assets/js/39.7c0f35e0.js"><link rel="prefetch" href="/assets/js/4.1ba239d4.js"><link rel="prefetch" href="/assets/js/41.f30deeb0.js"><link rel="prefetch" href="/assets/js/42.57b77ea8.js"><link rel="prefetch" href="/assets/js/43.b3315ca4.js"><link rel="prefetch" href="/assets/js/44.b17508ca.js"><link rel="prefetch" href="/assets/js/45.5b5c19a7.js"><link rel="prefetch" href="/assets/js/46.9e8ce819.js"><link rel="prefetch" href="/assets/js/47.28b35706.js"><link rel="prefetch" href="/assets/js/48.c0d87fd4.js"><link rel="prefetch" href="/assets/js/49.a1b41e8c.js"><link rel="prefetch" href="/assets/js/5.4eb38bec.js"><link rel="prefetch" href="/assets/js/50.8bba066d.js"><link rel="prefetch" href="/assets/js/51.8cf81ea4.js"><link rel="prefetch" href="/assets/js/52.a18442c1.js"><link rel="prefetch" href="/assets/js/53.9c4363f6.js"><link rel="prefetch" href="/assets/js/54.aa373bcf.js"><link rel="prefetch" href="/assets/js/55.71982d82.js"><link rel="prefetch" href="/assets/js/56.5abff6bf.js"><link rel="prefetch" href="/assets/js/57.0b66cd56.js"><link rel="prefetch" href="/assets/js/58.100b73b8.js"><link rel="prefetch" href="/assets/js/59.d9855a7f.js"><link rel="prefetch" href="/assets/js/6.d4f3d3fa.js"><link rel="prefetch" href="/assets/js/60.9e38f4e1.js"><link rel="prefetch" href="/assets/js/61.af4308f2.js"><link rel="prefetch" href="/assets/js/62.ccf1ac4f.js"><link rel="prefetch" href="/assets/js/63.c993d191.js"><link rel="prefetch" href="/assets/js/64.4471c1d1.js"><link rel="prefetch" href="/assets/js/65.e293c8a4.js"><link rel="prefetch" href="/assets/js/66.a2258361.js"><link rel="prefetch" href="/assets/js/67.b465570a.js"><link rel="prefetch" href="/assets/js/68.f5faede9.js"><link rel="prefetch" href="/assets/js/69.c5c7f24b.js"><link rel="prefetch" href="/assets/js/7.48b87eb4.js"><link rel="prefetch" href="/assets/js/70.a96c8ea1.js"><link rel="prefetch" href="/assets/js/71.6699ca68.js"><link rel="prefetch" href="/assets/js/72.cd05fcfb.js"><link rel="prefetch" href="/assets/js/73.6570ccec.js"><link rel="prefetch" href="/assets/js/74.6d9157b7.js"><link rel="prefetch" href="/assets/js/75.8b8f1b93.js"><link rel="prefetch" href="/assets/js/76.a1c0b7d3.js"><link rel="prefetch" href="/assets/js/77.e2237a8d.js"><link rel="prefetch" href="/assets/js/78.36aa1e85.js"><link rel="prefetch" href="/assets/js/79.92afca59.js"><link rel="prefetch" href="/assets/js/8.307db6b1.js"><link rel="prefetch" href="/assets/js/80.46b201f7.js"><link rel="prefetch" href="/assets/js/81.9939db5b.js"><link rel="prefetch" href="/assets/js/82.431ad0b8.js"><link rel="prefetch" href="/assets/js/83.2f42c6fa.js"><link rel="prefetch" href="/assets/js/84.156f49d3.js"><link rel="prefetch" href="/assets/js/85.f34a6202.js"><link rel="prefetch" href="/assets/js/86.060681ff.js"><link rel="prefetch" href="/assets/js/87.ddb48362.js"><link rel="prefetch" href="/assets/js/9.f92da099.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d0292b10.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="layout"><div id="navbar"><nav role="navigation" aria-label="main navigation" class="navbar"><div class="navbar-brand"><a href="/" class="navbar-item" style="font-weight:bold;color:black;">
      Wh@t !s Development?
    </a><a role="button" aria-label="menu" tabindex="0" class="navbar-burger burger"><span aria-hidden="true"></span><span aria-hidden="true"></span><span aria-hidden="true"></span></a></div><div class="navbar-menu"><div class="navbar-start"></div><div class="navbar-end"><a href="/" class="navbar-item">
      Home
    </a><a href="/about" class="navbar-item">
      About
    </a> <a href="/posts/app" class="navbar-item">
      앱
    </a><a href="/posts/cs" class="navbar-item">
      CS
    </a><a href="/posts/web" class="navbar-item">
      Web
    </a><a href="/posts/etc" class="navbar-item">
      그 외
    </a> <div class="navbar-item"><div class="buttons"><button type="button" class="button is-info"><!----><!----><span class="icon is-small"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="svg-inline--fa fa-github fa-w-16"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></span></button> <button type="button" class="button is-info"><!----><!----><span class="icon is-small"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="instagram" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="svg-inline--fa fa-instagram fa-w-14"><path fill="currentColor" d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"></path></svg></span></button> <button type="button" class="button is-info"><!----><span><span class="icon is-small"><img src="/images/white_notion.svg" width="15" height="15"></span></span><!----></button></div></div></div></div></nav></div> <div class="content"><div class="page post"><div class="columns"><div class="column"><p class="title is-4">MVVM - Mutation 처리를 예쁘게, 제대로 해보아요.</p></div> <div class="column is-2"><p class="subtitle is-5 date">2023-04-30</p></div></div> <div class="content__default" style="paddig:0;"><h3 id="시작하기-앞서">시작하기 앞서</h3> <p>프로젝트 노션에 있던 문서를 그대로 블로그로 옮긴 것입니다. MVVM을 안드로이드 프로젝트에 도입하면서 어느정도 정착한 구조입니다. 심각한 최적화 문제가 있을 수도 있습니다. 함부로 적용하는 바보짓은 하지 마시고, 능력자분들께서는 부디 이 구조의 문제점에 대해 지적하고 더 나은 구조를 가져갈 수 있도록 알려주시면 감사하겠습니다 🙏</p> <p>React Query에서 쓰이는 단어가 네트워크 요청을 표현하기 좋아 보여 사용해봤어요.</p> <ul><li>Query: 단건/다건 등 조회가 이루어지는 로직</li> <li>Mutation: 생성/수정/삭제 등 DB 변동을 일으키는 로직</li></ul> <h3 id="ui-단에서-네트워크-요청의-성공-실패가-반영되는-법-uierrorhandler">UI 단에서 네트워크 요청의 성공/실패가 반영되는 법 <code>UIErrorHandler</code></h3> <p>공통 에러를 제외하면 다음과 같다.</p> <ul><li>Query
<ol><li>UI에 표시 (커스텀 뷰에 데이터바인딩해서 선언적 에러 처리 가능, 명령적으로 처리 필요 X)</li> <li>Dialog/BottomSheet 등 Modal</li> <li>예외</li></ol></li> <li>Mutation
<ul><li>Dialog/BottomSheet 등 Modal</li> <li>Toast</li> <li>예외</li></ul></li></ul> <h3 id="공통로직-레이어화">공통로직 레이어화</h3> <ul><li>Activity/Fragment별 성공시 공통 로직?</li> <li>MutableStateFlow별 성공시 공통 로직?</li></ul> <p>⇒</p> <aside>
❓ Mutation의 Request에 대한 정보를 갖고 있어야 할까요? 
혹시 모를 예외를 대비하기 위해 갖고 있는 것으로 할게요.
</aside> <ol><li><p>MutableStateFlow에 emit 되는 Sealed Class MutationEvent의 SubClass 들은 Mutation Object에 <code>request</code> 와 <code>state</code> 를 갖고 있어 각 요청 별 상태 관리와 함께 기존 요청에 따른 액션 처리 또한 가능해요. 특히 이건 collector로 흐름이 이동함에 있어서 네트워크 요청 후에 요청에 담긴 데이터로 UI 변경이 필요한 경우 유용해요.</p> <p>ex) 댓글 삭제 요청에서 삭제된 댓글을 UI에 반영하기 위해 request에 담겨 있던 댓글 id 꺼내 해당 부분 UI에서 제거</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">sealed</span> <span class="token keyword">class</span> MutationEvent <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token function">UserMutationEvent</span><span class="token punctuation">(</span><span class="token keyword">open</span> <span class="token keyword">val</span> mutation<span class="token operator">:</span> Mutation<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">MutationEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token function">AddLikedMatchingInfo</span><span class="token punctuation">(</span><span class="token keyword">override</span> <span class="token keyword">val</span> mutation<span class="token operator">:</span> Mutation<span class="token operator">&lt;</span>MutateFavoriteRequestDto<span class="token punctuation">,</span> Boolean<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">:</span>
        <span class="token function">UserMutationEvent</span><span class="token punctuation">(</span>mutation<span class="token punctuation">)</span>
		<span class="token keyword">class</span> <span class="token function">ReportMatchingInfo</span><span class="token punctuation">(</span><span class="token keyword">override</span> <span class="token keyword">val</span> mutation<span class="token operator">:</span> Mutation<span class="token operator">&lt;</span>ReportRequestDto<span class="token punctuation">,</span> Boolean<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">:</span>
        <span class="token function">UserMutationEvent</span><span class="token punctuation">(</span>mutation<span class="token punctuation">)</span>
		<span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">data</span> <span class="token keyword">class</span> Mutation<span class="token operator">&lt;</span>P<span class="token punctuation">,</span> R<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">val</span> request<span class="token operator">:</span> P<span class="token punctuation">,</span> <span class="token keyword">val</span> state<span class="token operator">:</span> State<span class="token operator">&lt;</span>R<span class="token operator">&gt;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li> <li><p>MutableStateFlow를 collect 하고 있는 collector에서 이벤트를 분기해 처리해주어요.</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code>lifecycleScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
            viewModel<span class="token punctuation">.</span>userMutationEvent<span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{</span> event <span class="token operator">-&gt;</span>
                <span class="token function">setLoadingState</span><span class="token punctuation">(</span>event<span class="token operator">?</span><span class="token punctuation">.</span>mutation<span class="token operator">?</span><span class="token punctuation">.</span>state<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">isLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?:</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
                <span class="token keyword">when</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">is</span> UserMutationEvent<span class="token punctuation">.</span>AddLikedMatchingInfo <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>mutation<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">isError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            binding<span class="token punctuation">.</span>cardStackView<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                   <span class="token keyword">is</span> UserMutationEvent<span class="token punctuation">.</span>ReportMatchingInfo <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>mutation<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token function">OkDialog</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;사용자를 신고했어요. 불편을 드려 죄송해요.&quot;</span></span><span class="token punctuation">,</span> onOk <span class="token operator">=</span> 
                                modalBottomSheet<span class="token punctuation">.</span><span class="token function">dismissAllowingStateLoss</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@MatchingFragment</span><span class="token punctuation">.</span><span class="token function">requireContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>mutation<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">isError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token function">OkDialog</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;사용자 신고에 실패했어요.&quot;</span></span><span class="token punctuation">,</span> onOk <span class="token operator">=</span> <span class="token punctuation">{</span>
                                modalBottomSheet<span class="token punctuation">.</span><span class="token function">dismissAllowingStateLoss</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@MatchingFragment</span><span class="token punctuation">.</span><span class="token function">requireContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
									<span class="token operator">..</span><span class="token punctuation">.</span>
						<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div></li> <li><p>공통 작업을 처리 해주기 위해 collector 당 하나의 UIErrorHandler가 붙어요.</p></li> <li><p>UIErrorHandler는 주어진 특정 Event를 제외하고는 모두 공통 동작으로 동작하게 해요. (모달 등?)</p></li></ol> <h3 id="infrastructure">Infrastructure</h3> <ul><li><p>ResultUseCase</p> <p>runCatching을 이용해 성공일 경우 State.Success를, 실패할 경우 State.Error를 반환하는 abstract UseCase 클래스에요. 이 친구 덕에 미친듯이 중복되던 runCatching 코드를 줄이고, 여기서 나온 State를 바로 Mutation으로 wrap하고 emit할 수 있게 됐어요.</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> ResultUseCase<span class="token operator">&lt;</span>P<span class="token punctuation">,</span> R<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">abstract</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">onExecute</span><span class="token punctuation">(</span>params<span class="token operator">:</span> P<span class="token punctuation">)</span><span class="token operator">:</span> R

    <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">run</span><span class="token punctuation">(</span>params<span class="token operator">:</span> P<span class="token punctuation">)</span><span class="token operator">:</span> State<span class="token operator">&lt;</span>R<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            IDormLogger<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">&quot;Running UseCase </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression"><span class="token keyword">this</span></span></span><span class="token string"> with following params: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">params</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> kotlin<span class="token punctuation">.</span><span class="token function">runCatching</span> <span class="token punctuation">{</span>
                State<span class="token punctuation">.</span><span class="token function">Success</span><span class="token punctuation">(</span><span class="token function">onExecute</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">getOrElse</span> <span class="token punctuation">{</span> State<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            IDormLogger<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">,</span>
                <span class="token string-literal singleline"><span class="token string">&quot;Exception </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">e<span class="token punctuation">.</span>javaClass<span class="token punctuation">.</span>canonicalName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> occurred while running UseCase: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression"><span class="token keyword">this</span></span></span><span class="token string">\nDetail: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token expression">e<span class="token punctuation">.</span><span class="token function">stackTraceToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span></span>
            <span class="token punctuation">)</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div></li> <li><p>MutableStateFlow</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">private</span> <span class="token keyword">val</span> _userMutationEvent<span class="token operator">:</span> MutableStateFlow<span class="token operator">&lt;</span>UserMutationEvent<span class="token operator">?</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">MutableStateFlow</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> userMutationEvent<span class="token operator">:</span> MutableStateFlow<span class="token operator">&lt;</span>UserMutationEvent<span class="token operator">?</span><span class="token operator">&gt;</span>
        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> _userMutationEvent
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul> <h3 id="남겨진-숙제">남겨진 숙제</h3> <p>MVVM 구조에서 에러 처리를 공통적으로 할 수 있는건 빼내기 위해 노력해봤어요.</p> <ul><li><p>개발을 빠르게 진행하고 싶어서 막 하다보니 비슷한 아키텍처로 UiState, presentation.board.State 클래스와 함께 resultState 들이 나뉘어져 개발된 등 여러 시행착오로 남은 상처들이 있어요.</p> <p>이러한 이유로 일부 코드에서 패키지까지 적혀있어 코드가 더러워졌어요. 극혐이네요.</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token keyword">is</span> org<span class="token punctuation">.</span>appcenter<span class="token punctuation">.</span>inudorm<span class="token punctuation">.</span>util<span class="token punctuation">.</span>State<span class="token punctuation">.</span>Error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>에러 내용/성공 데이터 가져올 때 캐스팅 필수</p> <p>아래 코드에서 if 문을 이용해 state가 State.Error 임이 명확해졌음에도 명시적으로 type casting을 해야 해요. 이건 코틀린 제네릭에 대한 이해가 부족한 채로 개발해서 생긴 문제 같은데, 어떻게 해결할 방법이 있지 않을까요? 해결법을 아시는 분은 댓글에 달아주시면 깊이 감사하겠습니다.</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">private</span> <span class="token keyword">val</span> userMutationCollector <span class="token operator">=</span> FlowCollector<span class="token operator">&lt;</span>UserMutationEvent<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        IDormLogger<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">when</span> <span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">is</span> UserMutationEvent<span class="token punctuation">.</span>DeleteDislikedMatchingInfo<span class="token punctuation">,</span>
            <span class="token keyword">is</span> UserMutationEvent<span class="token punctuation">.</span>DeleteLikedMatchingInfo<span class="token punctuation">,</span>
            <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span>mutation<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> viewModel<span class="token punctuation">.</span><span class="token function">getMates</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span>mutation<span class="token punctuation">.</span>state <span class="token keyword">is</span> State<span class="token punctuation">.</span>Error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token operator">*</span><span class="token operator">*</span><span class="token function">OkDialog</span><span class="token punctuation">(</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>mutation<span class="token punctuation">.</span>state <span class="token keyword">as</span> State<span class="token punctuation">.</span>Error<span class="token punctuation">)</span><span class="token punctuation">.</span>error<span class="token punctuation">.</span>message <span class="token operator">?:</span> <span class="token string-literal singleline"><span class="token string">&quot;알 수 없는 오류입니다.&quot;</span></span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">is</span> UserMutationEvent<span class="token punctuation">.</span>ReportMatchingInfo <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li></ul></div> <div id="disqus_thread" class="comment"></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ddc79771.js" defer></script><script src="/assets/js/1.00a05d18.js" defer></script><script src="/assets/js/40.8b87d3bf.js" defer></script>
  </body>
</html>
